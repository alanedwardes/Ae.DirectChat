<html>

<head>
    <meta charset="UTF-8">
    <title>P2P Chat - Alan Edwardes</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
</head>

<style>
    form,
    p {
        margin: 0;
    }

    p {
        padding: .5em 0;
    }
    
    body, button {
        color:#eee;
        font-size:1.1em;
        font-family: 'Open Sans', sans-serif;
    }

    button, .window {
        background:#444;
        border-radius: 5px;
        box-shadow: rgba(0, 0, 0, 0.25) 0 0 25px;
        border:0;
        margin:1em;
        padding:.5em 1em;
    }

    body {
        overflow:hidden;
        width:100%;
        height:100%;
        padding:0;
        margin:0;
        background:radial-gradient(#444, #222);
    }

    #audioGainSlider {
        width: 512px;
    }

    .window {
        min-width:256px;
        float: left;
    }

    .closeButton {
        background:transparent;
        box-shadow:none;
        padding:0;
        float: right;
        margin:0;
    }

    .hidden {
        display: none;
    }

    #volumeCanvas {
        background:#333;
    }

    #localVideo {
        position:absolute;
        right:1em;
        bottom:1em;
        width:20%;
    }

    .remoteVideo {
        position:absolute;
        left:0px;
        right:0px;
        height: 100%;
        z-index: -1;
    }
</style>

<body>
    <div id="remoteVideo"></div>
    <button id="audioControlsButton">üé§ Audio Controls</button>
    <button id="videoControlsButton">üì∑ Video Controls</button>
    <button id="attendeeWindowButton">üßç Attendees</button>
    <div style="clear:both"></div>
    <div id="audioControls" class="window hidden">
        <button class="closeButton">‚úï</button>
        <p>üé§ Audio Controls</p>
        <canvas id="volumeCanvas" width="512" height="64"></canvas>
        <form>
            <p><label for="audioGainSlider">Local Gain: <span id="audioGainValue"></span></label></p>
            <p><input type="range" min="0" max="5" step="0.5" id="audioGainSlider" /></p>
            <p><input type="checkbox" id="checkboxAudioLocalListen" /> <label for="checkboxAudioLocalListen">Enable Local Listen</label></p>
            <p><input type="checkbox" id="checkboxAudioEchoCancellation" /> <label for="checkboxAudioEchoCancellation">Enable Echo Cancellation</label></p>
            <p><input type="checkbox" id="checkboxAudioNoiseSuppression" /> <label for="checkboxAudioNoiseSuppression">Enable Noise Suppression</label></p>
            <p><input type="checkbox" id="checkboxAudioAutoGainControl" /> <label for="checkboxAudioAutoGainControl">Enable Auto Gain Control</label></p>
            <p><input type="checkbox" id="checkboxAudioStereo" /> <label for="checkboxAudioStereo">Enable Stereo (Firefox attendees only)</label></p>
        </form>
    </div>
    <div id="videoControls" class="window hidden">
        <button class="closeButton">‚úï</button>
        <p>üì∑ Video Controls</p>
        <form>
            <p><input type="checkbox" id="cameraCheckbox" /> <label for="cameraCheckbox">Enable Camera</label></p>
        </form>
    </div>
    <div id="attendeeWindow" class="window hidden">
        <button class="closeButton">‚úï</button>
        <p>üßç Attendees</p>
        <ol id="attendeeList"></ol>
    </div>
    <video muted id="localVideo"></video>
    <script src="dist/bundle.js"></script>
    <script>
        window.onload = () => {
            let isLocal = !window.location.protocol.startsWith("http");
            
            let roomId;
            if (isLocal) {
                roomId = window.location.hash.replace('#', '');
            }
            else {
                roomId = window.location.pathname.replace('/', '');
            }

            if (roomId == "") {
                roomId = ChatApp.ChatApp.NewGuid();
                if (isLocal) {
                    window.location.hash = '#' + roomId;
                }
                else {
                    window.location.pathname = '/' + roomId;
                }
            }

            let joinSound = document.createElement("audio");
            joinSound.src = "https://s.edward.es/633bc8cc-fc86-4ad1-a1fe-46d815dc4e29.mp3";
            ChatApp.ChatApp.OnConnect = connectionId => {
                joinSound.play();

                let li = document.createElement("li");

                if (ChatApp.ChatApp.GetAttendeeId() == connectionId) {
                    li.innerHTML = connectionId + " (you)";
                }
                else {
                    li.innerHTML = connectionId;
                }
                document.querySelector("#attendeeList").appendChild(li)
            };

            let remoteVideo = {};

            let leaveSound = document.createElement("audio");
            leaveSound.src = "https://s.edward.es/59e427ea-fd86-4642-80a0-6fe6eba887d4.mp3";
            ChatApp.ChatApp.OnDisconnect = connectionId => {
                leaveSound.play();

                document.querySelector('#remoteVideo').removeChild(remoteVideo[connectionId]);
                delete remoteVideo[connectionId];

                let list = document.querySelector("#attendeeList");
                for (let i in list.children){
                    let item = list.children[i];
                    if (item.innerHTML == connectionId) {
                        list.removeChild(item);
                    }
                }
            };

            ChatApp.ChatApp.OnRemoteStream = (clientId, mediaStream) => {
                let video;
                if (remoteVideo.hasOwnProperty(clientId)) {
                    video = remoteVideo[clientId];
                }
                else {
                    video = document.createElement("video");
                    video.className = "remoteVideo";
                    document.querySelector('#remoteVideo').appendChild(video);
                    remoteVideo[clientId] = video;
                }

                video.srcObject = mediaStream;
                video.play();
            }

            ChatApp.ChatApp.OnLocalStream = (mediaStream) => {
                let video = document.querySelector('#localVideo');
                video.srcObject = mediaStream;
                video.play();
            }

            ChatApp.ChatApp.Start(roomId);

            setGainValue(1);

            document.querySelector('#audioGainSlider').addEventListener('input', event => {
                setGainValue(event.srcElement.value);
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.AudioGain = event.srcElement.value;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            document.querySelector('#checkboxAudioEchoCancellation').addEventListener('input', event => {
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.AudioEchoCancellation = event.srcElement.checked;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            document.querySelector('#checkboxAudioNoiseSuppression').addEventListener('input', event => {
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.AudioNoiseSuppression = event.srcElement.checked;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            document.querySelector('#checkboxAudioAutoGainControl').addEventListener('input', event => {
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.AudioAutoGainControl = event.srcElement.checked;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            document.querySelector('#checkboxAudioStereo').addEventListener('input', event => {
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.AudioStereo = event.srcElement.checked;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            document.querySelector('#checkboxAudioLocalListen').addEventListener('input', event => {
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.AudioLocalListen = event.srcElement.checked;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            document.querySelector('#audioControlsButton').addEventListener('click', event => {
                document.querySelector('#audioControls').classList.remove("hidden");
                drawAudioMeter();
            });

            function drawAudioMeter() {
                if (document.querySelector('#audioControls').classList.contains("hidden")) {
                    return;
                }

                let canvas = document.getElementById("volumeCanvas");
                let context = canvas.getContext("2d");
                let sample = ChatApp.ChatApp.GetAudioLevel();

                context.clearRect(0, 0, canvas.width, canvas.height)

                context.fillStyle = "green";

                if (sample > .80) {
                    context.fillStyle = "orange";
                }

                if (sample > .95) {
                    context.fillStyle = "red";
                }

                context.fillRect(0, 0, canvas.width * sample, 64);

                window.requestAnimationFrame(() => drawAudioMeter());
            }

            document.querySelector('#videoControlsButton').addEventListener('click', event => {
                document.querySelector('#videoControls').classList.remove("hidden");
            });

            document.querySelector('#attendeeWindowButton').addEventListener('click', event => {
                document.querySelector('#attendeeWindow').classList.remove("hidden");
            });

            document.querySelector('#cameraCheckbox').addEventListener('input', event => {
                let settings = ChatApp.ChatApp.GetMediaSettings();
                settings.VideoEnabled = event.srcElement.checked;
                ChatApp.ChatApp.SetMediaSettings(settings);
            });

            function setGainValue(value) {
                document.querySelector('#audioGainSlider').value = value;
                document.querySelector('#audioGainValue').innerHTML = value;
            }

            document.querySelectorAll('.closeButton').forEach(element => {
                element.addEventListener('click', event => {
                    event.srcElement.parentElement.classList.add("hidden");
                });
            });
        };
    </script>
</body>

</html>